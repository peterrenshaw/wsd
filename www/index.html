<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>D3 JSON &copy; data read</title>
        <script type="text/javascript" src="js/d3.js"></script>
    </head>
    <body>
        <script type="text/javascript">
            // HEADER
            d3.json("http://127.0.0.1:8000/data/latest-simple-weather-header.json").then( function(data) {
                return data;
            })
            .then(function(d) {
                // label
                d3.select("body") 
                  .selectAll("h4")
	          .data(d)
                  .enter()
	          .append("h4")
		  .text(function(d) {
	               return d;
		  })
            })
            .catch( error => console.log("Error: " + error) );


            // GRAPH
            var parser = d3.timeParse("%m/%dT%H%M");
            d3.json("http://127.0.0.1:8000/data/latest-simple-weather.json").then( function(data) {
                return data;
            })
            .then( function (data) {
                var d = [];
                for (i = 0; i < data.length; i++) {
                        // create a Date object
                        var dt = new Date(data[i].local_date_time_iso);

                        // format dt to hour
                        var hourFormater = d3.timeFormat("%H:%M%");
                        var hour = d3.timeHour.round(dt);

                        // create dict for d3
                        d[i] = data[i].apparent_t;
                        /*
                        d[i] = {'temp':  data[i].apparent_t,
                                'wind':  data[i].gust_kmh,
                                'humid': data[i].rel_hum, 
                                'hour':  hourFormater(hour)};
                        */
                }
                return d;
            })
            .then( function (data) {
                var w = 800;
                var h = 200;
                var barPadding = 0.8;

                // svg container for weather
                var svg = d3.select("body")
                            .append("svg")
                            .attr("width", w)  
                            .attr("height", h);

                // show height of temp
                svg.selectAll("rect")
                   .data(data)
                   .enter()
                   .append("rect")
                   .attr("y", function(d) {
                       return h - (d * 4);
                   })
                   .attr("height", function(d) {
                       return d * 40;
                   })
                   .attr("x", function(d, i) {
                       	return i * (w / data.length);
                   })
                   .attr("width", w / data.length - barPadding)
                   .attr("stroke", function(d) {
                       return "white";
                   })
                   .attr("stroke-width", "0.1")
                   .attr("fill", function(d) {
                       return d3.rgb(d*10, 180 + d*1.5, 140 + d, 1.0);
                   })

                 // show data point of temp
                 svg.selectAll("circle")
                    .data(data)
                    .enter()
                    .append("circle")
                    .attr("cy", function(d) {
                       return h - (d * 4) + 2;
                    })
                    .attr("cx", function(d, i) {
                        return i * (w / data.length) + (w / data.length - barPadding) / 2
                    })
                    .attr("r", 1);
                 
                 // show temp value
                 svg.selectAll("text")
                    .data(data)
                    .enter()
                    .append("text")
                    .text(function(d) {
                        //return Math.floor(d);
                        return "";
                    })
                    .attr("font-family", "sans-serif")
                    .attr("font-size", "6pt")
                    .attr("fill", "black")
                    .attr("y", function(d) {
                        return h - (d * 4) - 10;
                    })
                    .attr("x", function(d, i) {
                        return (i * (w / data.length) + (w / data.length - barPadding) / 2 ) - 6
                    });
            })
            .catch( error => console.log("Error: " + error) );
            // HEADER
            d3.json("http://127.0.0.1:8000/data/latest-simple-weather-header.json").then( function(data) {
                return data;
            })
            .then(function(d) {
                // label
                d3.select("body") 
                  .selectAll("h4")
	          .data(d)
                  .enter()
	          .append("h4")
		  .text(function(d) {
	               return d;
		  })
            })
            .catch( error => console.log("Error: " + error) );

        </script>
    </body>
</html>
